<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphSec-IaC - Visualizaci√≥n de Infraestructura y Seguridad</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        
        #graph-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
        }
        
        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2196f3;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .vulnerability-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .vulnerability-item {
            padding: 8px;
            margin: 5px 0;
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .vulnerability-item.critical {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .vulnerability-item.high {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        
        .vulnerability-item.medium {
            background: #fff8e1;
            border-left-color: #ffc107;
        }
        
        .vulnerability-item.low {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GraphSec-IaC</h1>
            <p>Visualizaci√≥n de Infraestructura y An√°lisis de Seguridad</p>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <p>üîÑ Cargando grafo de infraestructura...</p>
                <p>Esto puede tomar unos segundos mientras se ejecuta el an√°lisis completo.</p>
            </div>
            
            <div id="error" class="error" style="display: none;">
                <h3>‚ùå Error al cargar el grafo</h3>
                <p id="error-message"></p>
            </div>
            
            <div id="success" class="success" style="display: none;">
                <h3>‚úÖ An√°lisis completado exitosamente</h3>
                <p>El grafo de infraestructura se ha cargado con informaci√≥n de seguridad.</p>
            </div>
            
            <div id="stats" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="total-nodes">0</div>
                    <div class="stat-label">Nodos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-edges">0</div>
                    <div class="stat-label">Dependencias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-findings">0</div>
                    <div class="stat-label">Hallazgos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="vulnerable-nodes">0</div>
                    <div class="stat-label">Nodos Vulnerables</div>
                </div>
            </div>
            
            <div id="graph-container"></div>
            
            <div id="info-panel" class="info-panel" style="display: none;">
                <h3>Informaci√≥n del Nodo Seleccionado</h3>
                <div id="node-info">
                    <p><strong>ID:</strong> <span id="node-id"></span></p>
                    <p><strong>Tipo:</strong> <span id="node-type"></span></p>
                    <p><strong>Problemas de Seguridad:</strong> <span id="node-issues-count"></span></p>
                    <div id="vulnerabilities" class="vulnerability-list" style="display: none;">
                        <h4>Vulnerabilidades Detectadas:</h4>
                        <div id="vulnerability-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir vis.js desde CDN -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <script>
        let network = null;
        let graphData = null;
        
        // Funci√≥n para mostrar error
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
        
        // Funci√≥n para mostrar √©xito
        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }
        
        // Funci√≥n para actualizar estad√≠sticas
        function updateStats(data) {
            const nodes = data.nodes || [];
            const edges = data.edges || [];
            const correlationMetadata = data.correlation_metadata || {};
            const apiMetadata = data.api_metadata || {};
            
            document.getElementById('total-nodes').textContent = nodes.length;
            document.getElementById('total-edges').textContent = edges.length;
            document.getElementById('total-findings').textContent = apiMetadata.total_findings || 0;
            document.getElementById('vulnerable-nodes').textContent = correlationMetadata.nodes_with_issues || 0;
            
            document.getElementById('stats').style.display = 'grid';
        }
        
        // Funci√≥n para procesar datos del grafo para vis.js
        function processGraphData(data) {
            const nodes = data.nodes || [];
            const edges = data.edges || [];
            
            console.log('Procesando datos del grafo:', {
                totalNodes: nodes.length,
                totalEdges: edges.length,
                nodes: nodes.map(n => ({ id: n.id, type: n.type })),
                edges: edges.map(e => ({ from: e.source || e.from, to: e.target || e.to }))
            });
            
            // Procesar nodos
            const visNodes = nodes.map((node, index) => {
                const hasIssues = node.security_issues && node.security_issues.length > 0;
                
                return {
                    id: node.id || `node_${index}`,
                    label: node.label || node.simple_name || node.id || `Nodo ${index}`,
                    color: hasIssues ? '#ff4d4d' : '#97c2fc',
                    borderWidth: hasIssues ? 3 : 1,
                    borderColor: hasIssues ? '#d32f2f' : '#1976d2',
                    font: {
                        color: hasIssues ? '#d32f2f' : '#1976d2',
                        size: 14,
                        bold: hasIssues
                    },
                    shape: 'box',
                    margin: 10,
                    // Almacenar datos originales del nodo
                    originalData: node
                };
            });
            
            // Procesar aristas
            const visEdges = edges.map((edge, index) => {
                const sourceId = edge.source || edge.from;
                const targetId = edge.target || edge.to;
                
                // Verificar que tanto el origen como el destino existen en los nodos
                const sourceExists = visNodes.some(node => node.id === sourceId);
                const targetExists = visNodes.some(node => node.id === targetId);
                
                if (!sourceExists || !targetExists) {
                    console.warn(`Arista ${index}: Nodo origen o destino no encontrado`, { sourceId, targetId, sourceExists, targetExists });
                    return null;
                }
                
                return {
                    id: `edge_${index}`,
                    from: sourceId,
                    to: targetId,
                    color: {
                        color: '#666666',
                        highlight: '#1976d2',
                        hover: '#ff6b35'
                    },
                    width: 3,
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 1.2,
                            type: 'arrow'
                        }
                    },
                    smooth: {
                        type: 'continuous',
                        forceDirection: 'none',
                        roundness: 0.4
                    },
                    shadow: true,
                    label: edge.label || '', // Etiqueta opcional para la arista
                    font: {
                        color: '#343434',
                        size: 12,
                        background: 'rgba(255,255,255,0.7)'
                    }
                };
            }).filter(edge => edge !== null); // Filtrar aristas inv√°lidas
            
            return {
                nodes: visNodes,
                edges: visEdges
            };
        }
        
        // Funci√≥n para mostrar informaci√≥n del nodo
        function showNodeInfo(nodeData) {
            // Usar el ID completo del recurso, con fallback a label o simple_name
            const nodeId = nodeData.id || nodeData.label || nodeData.simple_name || 'unknown';
            const nodeType = nodeData.type || 'unknown';
            const securityIssues = nodeData.security_issues || [];
            
            document.getElementById('node-id').textContent = nodeId;
            document.getElementById('node-type').textContent = nodeType;
            document.getElementById('node-issues-count').textContent = securityIssues.length;
            
            if (securityIssues.length > 0) {
                document.getElementById('vulnerabilities').style.display = 'block';
                const vulnerabilityList = document.getElementById('vulnerability-list');
                vulnerabilityList.innerHTML = '';
                
                securityIssues.forEach((issue, index) => {
                    const item = document.createElement('div');
                    item.className = `vulnerability-item ${issue.level || 'medium'}`;
                    item.innerHTML = `
                        <strong>${issue.rule_id || 'N/A'}</strong><br>
                        ${issue.message || 'Sin descripci√≥n'}
                    `;
                    vulnerabilityList.appendChild(item);
                });
            } else {
                document.getElementById('vulnerabilities').style.display = 'none';
            }
            
            document.getElementById('info-panel').style.display = 'block';
        }
        
        // Funci√≥n para inicializar la visualizaci√≥n
        function initializeVisualization(data) {
            const processedData = processGraphData(data);
            
            // Configuraci√≥n de la red
            const options = {
                nodes: {
                    shape: 'box',
                    margin: 10,
                    font: {
                        size: 14
                    },
                    borderWidth: 2,
                    shadow: true
                },
                edges: {
                    width: 3,
                    color: {
                        color: '#666666',
                        highlight: '#1976d2',
                        hover: '#ff6b35'
                    },
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 1.2,
                            type: 'arrow'
                        }
                    },
                    smooth: {
                        type: 'continuous',
                        forceDirection: 'none',
                        roundness: 0.4
                    },
                    shadow: true,
                    font: {
                        color: '#343434',
                        size: 12,
                        background: 'rgba(255,255,255,0.7)'
                    }
                },
                physics: {
                    enabled: true,
                    stabilization: {
                        iterations: 200,
                        updateInterval: 10
                    },
                    barnesHut: {
                        gravitationalConstant: -2000,
                        centralGravity: 0.1,
                        springLength: 95,
                        springConstant: 0.04,
                        damping: 0.09
                    }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: true,
                    tooltipDelay: 300
                },
                layout: {
                    improvedLayout: true
                }
            };
            
            // Crear la red
            const container = document.getElementById('graph-container');
            network = new vis.Network(container, processedData, options);
            
            // Evento de clic en nodos
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const nodeData = processedData.nodes.find(n => n.id === nodeId);
                    if (nodeData) {
                        showNodeInfo(nodeData.originalData);
                    }
                }
            });
            
            // Evento de estabilizaci√≥n
            network.on('stabilizationIterationsDone', function() {
                network.setOptions({ physics: false });
            });
        }
        
        // Funci√≥n principal para cargar el grafo
        async function loadGraph() {
            try {
                console.log('Iniciando carga del grafo...');
                
                const response = await fetch('/api/graph');
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos del grafo recibidos:', data);
                
                // Almacenar datos globalmente
                graphData = data;
                
                // Mostrar √©xito
                showSuccess();
                
                // Actualizar estad√≠sticas
                updateStats(data);
                
                // Inicializar visualizaci√≥n
                initializeVisualization(data);
                
            } catch (error) {
                console.error('Error al cargar el grafo:', error);
                showError(`Error al cargar el grafo: ${error.message}`);
            }
        }
        
        // Cargar el grafo cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', loadGraph);
    </script>
</body>
</html>
