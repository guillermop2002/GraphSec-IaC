<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GraphSec-IaC - Visualizaci贸n de Infraestructura y Seguridad</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        
        .content {
            padding: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #666;
        }
        
        .error {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #f44336;
        }
        
        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
            border-left: 4px solid #4caf50;
        }
        
        #graph-container {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #fafafa;
        }
        
        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
            border-left: 4px solid #2196f3;
        }
        
        .info-panel h3 {
            margin-top: 0;
            color: #1976d2;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2196f3;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .vulnerability-list {
            max-height: 200px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        
        .vulnerability-item {
            padding: 8px;
            margin: 5px 0;
            background: #fff3e0;
            border-left: 3px solid #ff9800;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .vulnerability-item.critical {
            background: #ffebee;
            border-left-color: #f44336;
        }
        
        .vulnerability-item.high {
            background: #fff3e0;
            border-left-color: #ff9800;
        }
        
        .vulnerability-item.medium {
            background: #fff8e1;
            border-left-color: #ffc107;
        }
        
        .vulnerability-item.low {
            background: #e8f5e8;
            border-left-color: #4caf50;
        }
        
        .vulnerability-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .tool-badge {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .tool-badge.checkov {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }
        
        .tool-badge.trivy {
            background: #f3e5f5;
            color: #7b1fa2;
            border: 1px solid #ce93d8;
        }
        
        .vulnerability-message {
            margin: 4px 0;
            line-height: 1.4;
        }
        
        .vulnerability-meta {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }
        
        #unassigned-panel {
            margin-top: 20px;
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }
        
        #unassigned-panel h3 {
            color: #f57c00;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>GraphSec-IaC</h1>
            <p>Visualizaci贸n de Infraestructura y An谩lisis de Seguridad</p>
        </div>
        
        <div class="content">
            <div id="loading" class="loading">
                <p> Cargando grafo de infraestructura...</p>
                <p>Esto puede tomar unos segundos mientras se ejecuta el an谩lisis completo.</p>
            </div>
            
            <div id="error" class="error" style="display: none;">
                <h3>Error al cargar el grafo</h3>
                <p id="error-message"></p>
            </div>
            
            <div id="success" class="success" style="display: none;">
                <h3>An谩lisis completado exitosamente</h3>
                <p>El grafo de infraestructura se ha cargado con informaci贸n de seguridad.</p>
            </div>
            
            <div id="stats" class="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="stat-nodes">0</div>
                    <div class="stat-label">Nodos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-edges">0</div>
                    <div class="stat-label">Dependencias</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-findings">0</div>
                    <div class="stat-label">Hallazgos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-vuln-nodes">0</div>
                    <div class="stat-label">Nodos Vulnerables</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-duplicates">0</div>
                    <div class="stat-label">Duplicados Eliminados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="stat-scanners">0</div>
                    <div class="stat-label">Esc谩neres Usados</div>
                </div>
            </div>
            
            <div id="graph-container"></div>
            
            <div id="unassigned-panel" class="info-panel" style="display: none;">
                <h3>Hallazgos No Asignados</h3>
                <p style="font-size: 0.9em; color: #666; margin-bottom: 15px;">
                    Estos hallazgos no pudieron ser correlacionados con ning煤n nodo del grafo.
                    Pueden estar en m贸dulos (<code>modules/</code>) que no est谩n en el grafo, 
                    ser recursos <code>provider</code> o <code>terraform</code>, o tener rutas/l铆neas que no coinciden.
                </p>
                <div id="unassigned-findings" class="vulnerability-list">
                    <!-- Se poblar谩 din谩micamente -->
                </div>
            </div>
            
            <div id="info-panel" class="info-panel" style="display: none;">
                <h3>Informaci贸n del Nodo Seleccionado</h3>
                <div id="node-info">
                    <p><strong>ID:</strong> <span id="node-id"></span></p>
                    <p><strong>Tipo:</strong> <span id="node-type"></span></p>
                    <p><strong>Problemas de Seguridad:</strong> <span id="node-issues-count"></span></p>
                    <div id="vulnerabilities" class="vulnerability-list" style="display: none;">
                        <h4>Vulnerabilidades Detectadas:</h4>
                        <div id="vulnerability-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Incluir vis.js desde CDN -->
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    
    <script>
        let network = null;
        let graphData = null;
        
        // Funci贸n para mostrar error
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('error-message').textContent = message;
        }
        
        // Funci贸n para mostrar 茅xito
        function showSuccess() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('success').style.display = 'block';
        }
        
        // Funci贸n para mostrar hallazgos no asignados
        function displayUnassignedFindings(data) {
            const unassigned = data.unassigned_findings || [];
            const panel = document.getElementById('unassigned-panel');
            const container = document.getElementById('unassigned-findings');
            
            if (unassigned.length === 0) {
                panel.style.display = 'none';
                return;
            }
            
            panel.style.display = 'block';
            container.innerHTML = '';
            
            unassigned.forEach((finding, index) => {
                const item = document.createElement('div');
                item.className = 'vulnerability-item medium';
                
                const severity = finding.level || 'unknown';
                const severityClass = severity.toLowerCase();
                item.className = `vulnerability-item ${severityClass}`;
                
                const toolName = finding.tool_name || 'unknown';
                const toolClass = toolName.toLowerCase().includes('checkov') ? 'checkov' : 'trivy';
                
                item.innerHTML = `
                    <div class="vulnerability-header">
                        <span class="tool-badge ${toolClass}">${toolName}</span>
                        <strong>${finding.rule_id || 'Unknown Rule'}</strong>
                        <span style="margin-left: auto; font-size: 0.85em; color: #666;">Severidad: ${severity}</span>
                    </div>
                    <div class="vulnerability-message">
                        ${finding.message || 'No message available'}
                    </div>
                    <div class="vulnerability-meta">
                         ${finding.file_path || 'Unknown file'} | L铆nea ${finding.start_line || 'N/A'} | 
                        Capa de correlaci贸n: ${finding.correlation_layer || 0}
                    </div>
                `;
                
                container.appendChild(item);
            });
        }
        
        // Funci贸n para actualizar estad铆sticas
        function updateStatistics(data) {
            // 'data' es el objeto JSON completo
            const metadata = data.api_metadata || {};
            const correlation = metadata.correlation_metadata || {};

            const unique_findings = metadata.total_findings_unique || 0;
            const duplicates_removed = metadata.duplicates_removed || 0;
            let scanners_used = metadata.scanners_used || 0; 
            if (scanners_used === 0) {
                if (metadata.checkov_success && metadata.trivy_success) {
                    scanners_used = 2;
                } else if (metadata.checkov_success || metadata.trivy_success) {
                    scanners_used = 1;
                } else if (data.nodes) {
                    const all_findings = [...(data.unassigned_findings || [])];
                    data.nodes.forEach(n => all_findings.push(...(n.security_issues || [])));
                    const sources = new Set(all_findings.flatMap(f => f.sources || [f.tool_name]));
                    scanners_used = sources.size > 0 ? sources.size : 1;
                } else {
                    scanners_used = 1;
                }
            }
            document.getElementById('stat-nodes').textContent = metadata.total_nodes || data.nodes?.length || 0;
            document.getElementById('stat-edges').textContent = metadata.total_edges || data.edges?.length || 0;
            document.getElementById('stat-findings').textContent = unique_findings;
            document.getElementById('stat-vuln-nodes').textContent = correlation.nodes_with_issues_count || 0;
            document.getElementById('stat-duplicates').textContent = duplicates_removed;
            document.getElementById('stat-scanners').textContent = scanners_used;
            
            // Mostrar el panel de estad铆sticas
            document.getElementById('stats').style.display = 'grid';
        }
        
        // Funci贸n para procesar datos del grafo para vis.js
        function processGraphData(data) {
            const nodes = data.nodes || [];
            const edges = data.edges || [];
            
            console.log('Procesando datos del grafo:', {
                totalNodes: nodes.length,
                totalEdges: edges.length,
                nodes: nodes.map(n => ({ id: n.id, type: n.type, label: n.label, simple_name: n.simple_name })),
                edges: edges.map(e => ({ from: e.source || e.from, to: e.target || e.to, edge_type: e.edge_type }))
            });
            
            // Procesar nodos - USAR EL ID NICO DEL BACKEND
            const visNodes = nodes.map((node, index) => {
                const hasIssues = node.security_issues && node.security_issues.length > 0;
                
                // Usar el ID 煤nico del backend (con contador), NO simple_name
                const nodeId = node.id || `node_${index}`;
                
                console.log(`Procesando nodo ${index}:`, { 
                    originalId: node.id, 
                    simpleName: node.simple_name, 
                    finalId: nodeId,
                    label: node.label 
                });
                
                // Posiciones iniciales para mejor separaci贸n
                const initialPositions = [
                    { x: -200, y: -100 },  // Primer nodo (izquierda arriba)
                    { x: 200, y: 100 }     // Segundo nodo (derecha abajo)
                ];
                
                return {
                    id: nodeId, // Usar el ID que realmente viene del backend
                    label: node.label || node.simple_name || node.id || `Nodo ${index}`,
                    color: hasIssues ? '#ff4d4d' : '#97c2fc',
                    borderWidth: hasIssues ? 3 : 1,
                    borderColor: hasIssues ? '#d32f2f' : '#1976d2',
                    font: {
                        color: hasIssues ? '#d32f2f' : '#1976d2',
                        size: 14,
                        bold: hasIssues
                    },
                    shape: 'box',
                    margin: 25,                       // Mayor margen para evitar solapamiento
                    x: initialPositions[index]?.x,
                    y: initialPositions[index]?.y,
                    // Almacenar datos originales del nodo
                    originalData: node
                };
            });
            
            // Procesar aristas - VERSIN SIMPLIFICADA
            const visEdges = edges.map((edge, index) => {
                const sourceId = edge.source || edge.from;
                const targetId = edge.target || edge.to;
                
                console.log(`Procesando arista ${index}:`, { sourceId, targetId, edge });
                console.log(`IDs de nodos disponibles:`, visNodes.map(n => n.id));
                
                // Verificar que tanto el origen como el destino existen en los nodos
                const sourceExists = visNodes.some(node => node.id === sourceId);
                const targetExists = visNodes.some(node => node.id === targetId);
                
                console.log(`Validaci贸n de arista ${index}:`, { 
                    sourceExists, 
                    targetExists, 
                    sourceId, 
                    targetId,
                    visNodeIds: visNodes.map(n => n.id)
                });
                
                if (!sourceExists || !targetExists) {
                    console.warn(`Arista ${index}: Nodo origen o destino no encontrado`, { 
                        sourceId, 
                        targetId, 
                        sourceExists, 
                        targetExists,
                        availableIds: visNodes.map(n => n.id)
                    });
                    return null;
                }
                
                // Crear arista SIMPLE para asegurar que se muestre
                return {
                    id: `edge_${index}`,
                    from: sourceId,
                    to: targetId,
                    color: '#666666',
                    width: 4,
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 1.5,
                            type: 'arrow'
                        }
                    },
                    smooth: false, // L铆nea recta para mejor visibilidad
                    label: edge.label || ''
                };
            }).filter(edge => edge !== null); // Filtrar aristas inv谩lidas
            
            console.log('Aristas procesadas para vis.js:', visEdges);
            console.log('Nodos procesados para vis.js:', visNodes.map(n => ({ id: n.id, label: n.label })));
            
            return {
                nodes: visNodes,
                edges: visEdges
            };
        }
        
        // Funci贸n para mostrar informaci贸n del nodo
        function showNodeInfo(nodeData) {
            // Usar el ID completo del recurso, con fallback a label o simple_name
            const nodeId = nodeData.id || nodeData.label || nodeData.simple_name || 'unknown';
            const nodeType = nodeData.type || 'unknown';
            const securityIssues = nodeData.security_issues || [];
            
            document.getElementById('node-id').textContent = nodeId;
            document.getElementById('node-type').textContent = nodeType;
            document.getElementById('node-issues-count').textContent = securityIssues.length;
            
            if (securityIssues.length > 0) {
                document.getElementById('vulnerabilities').style.display = 'block';
                const vulnerabilityList = document.getElementById('vulnerability-list');
                vulnerabilityList.innerHTML = '';
                
                securityIssues.forEach((issue, index) => {
                    const item = document.createElement('div');
                    item.className = `vulnerability-item ${issue.level || 'medium'}`;
                    
                    // Obtener nombre de la herramienta y crear etiqueta
                    const toolName = issue.tool_name || 'unknown';
                    const toolBadge = toolName === 'Checkov' ? 
                        '<span class="tool-badge checkov">[Checkov]</span>' : 
                        '<span class="tool-badge trivy">[Trivy]</span>';
                    
                    item.innerHTML = `
                        <div class="vulnerability-header">
                            ${toolBadge}
                            <strong>${issue.rule_id || 'N/A'}</strong>
                        </div>
                        <div class="vulnerability-message">
                            ${issue.message || 'Sin descripci贸n'}
                        </div>
                        <div class="vulnerability-meta">
                            Severidad: ${issue.level || 'unknown'}
                        </div>
                    `;
                    vulnerabilityList.appendChild(item);
                });
            } else {
                document.getElementById('vulnerabilities').style.display = 'none';
            }
            
            document.getElementById('info-panel').style.display = 'block';
        }
        
        // Funci贸n para inicializar la visualizaci贸n
        function initializeVisualization(data) {
            const processedData = processGraphData(data);
            
            // Configuraci贸n de la red - SIMPLIFICADA para asegurar que las aristas se muestren
            const options = {
                nodes: {
                    shape: 'box',
                    margin: 25,                       // Mayor margen alrededor de los nodos (aumentado de 15)
                    font: {
                        size: 14,
                        color: '#333333'
                    },
                    borderWidth: 2,
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 5,
                        x: 2,
                        y: 2
                    }
                },
                edges: {
                    width: 4,
                    color: {
                        color: '#666666',
                        highlight: '#1976d2',
                        hover: '#ff6b35'
                    },
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 1.5,
                            type: 'arrow'
                        }
                    },
                    smooth: {
                        type: 'dynamic',
                        forceDirection: 'none'
                    },
                    shadow: {
                        enabled: true,
                        color: 'rgba(0,0,0,0.2)',
                        size: 3,
                        x: 1,
                        y: 1
                    }
                },
                physics: {
                    enabled: true,
                    stabilization: {
                        iterations: 300,              // M谩s iteraciones para mejor estabilizaci贸n
                        updateInterval: 50
                    },
                    solver: 'forceAtlas2Based',
                    forceAtlas2Based: {
                        gravitationalConstant: -500,  // M谩s repulsi贸n entre nodos (aumentado de -200)
                        centralGravity: 0.001,        // Menos atracci贸n al centro (reducido de 0.005)
                        springLength: 400,            // Mayor longitud de resorte (aumentado de 200)
                        springConstant: 0.02,         // Menos fuerza de resorte (reducido de 0.05)
                        damping: 0.8,                 // M谩s amortiguaci贸n para estabilidad (aumentado de 0.6)
                        avoidOverlap: 1.0             // Evitar solapamiento (0-1, 1 = m谩ximo)
                    }
                },
                interaction: {
                    hover: true,
                    selectConnectedEdges: true,
                    tooltipDelay: 200
                }
            };
            
            // Crear la red
            const container = document.getElementById('graph-container');
            network = new vis.Network(container, processedData, options);
            
            // Evento de clic en nodos
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    const nodeId = params.nodes[0];
                    const nodeData = processedData.nodes.find(n => n.id === nodeId);
                    if (nodeData) {
                        showNodeInfo(nodeData.originalData);
                    }
                }
            });
            
            // Evento de estabilizaci贸n
            network.on('stabilizationIterationsDone', function() {
                console.log('Estabilizaci贸n completada, deshabilitando f铆sica');
                
                // Mantener las posiciones actuales y deshabilitar f铆sica
                network.setOptions({ 
                    physics: false,
                    interaction: {
                        dragNodes: true,
                        dragView: true,
                        zoomView: true,
                        hover: true,
                        selectConnectedEdges: true,
                        tooltipDelay: 200
                    }
                });
                
                // Forzar redibujado para asegurar que las aristas se muestren
                setTimeout(() => {
                    network.redraw();
                    console.log('Redibujado forzado completado');
                }, 100);
            });
            
            // Evento adicional para debug
            network.on('afterDrawing', function() {
                console.log('Redibujado completado');
            });
        }
        
        // Funci贸n principal para cargar el grafo
        async function loadGraph() {
            try {
                console.log('Iniciando carga del grafo...');
                
                // Detectar modo de carga: desde informe de PR o desde API local
                const params = new URLSearchParams(window.location.search);
                const reportUrl = params.get('report'); // Nuevo: Buscar un ?report=...
                
                let endpoint;
                if (reportUrl) {
                    // MODO 1: Cargar desde un informe de PR
                    // reportUrl es la URL completa al JSON generado por la Action
                    endpoint = reportUrl;
                    console.log(`Cargando informe de PR desde: ${endpoint}`);
                } else {
                    // MODO 2: Demo Local (como antes)
                    const useVpc = params.has('vpc');
                    const useEks = params.has('eks');
                    endpoint = '/api/graph'; // Por defecto: test_infra
                    
                    if (useVpc) {
                        endpoint = '/api/graph?project=vpc';
                    } else if (useEks) {
                        endpoint = '/api/graph?project=eks';
                    }
                    console.log(`Cargando demo local desde: ${endpoint}`);
                }
                
                const response = await fetch(endpoint);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || `Error HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Datos del grafo recibidos:', data);
                
                // Almacenar datos globalmente
                window.graphData = data;
                graphData = data;
                
                // Mostrar 茅xito
                showSuccess();
                
                // Actualizar estad铆sticas
                updateStatistics(data);
                
                // Mostrar hallazgos no asignados
                displayUnassignedFindings(data);
                
                // Inicializar visualizaci贸n
                initializeVisualization(data);
                
            } catch (error) {
                console.error('Error al cargar el grafo:', error);
                showError(`Error al cargar el grafo: ${error.message}`);
            }
        }
        
        // Cargar el grafo cuando se carga la p谩gina
        document.addEventListener('DOMContentLoaded', loadGraph);
    </script>
</body>
</html>
