name: 'GraphSec-IaC AnÃ¡lisis de Seguridad'

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecuciÃ³n manual desde GitHub Actions
  push:
    branches: [ main ]  # Ejecutar tambiÃ©n cuando se hace push a main

jobs:
  analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      # 1. Checkout del cÃ³digo del PR
      - name: Checkout del cÃ³digo
        uses: actions/checkout@v4
      
      # 2. Configurar Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. Configurar Terraform
      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
      
      # 4. Instalar Trivy (via apt-get)
      - name: Instalar Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
      
      # 5. Instalar dependencias de Python (Checkov, etc.)
      - name: Instalar dependencias de Python
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          # Forzar instalaciÃ³n de checkov explÃ­citamente
          python -m pip install checkov
          # Verificar que checkov estÃ¡ instalado y disponible
          which checkov || echo "Checkov no encontrado en PATH"
          checkov --version || echo "Checkov no se puede ejecutar"
      
      # 6. Clonar el repositorio de EKS (para prueba)
      - name: Clonar el repositorio de EKS (para prueba)
        run: |
          git clone https://github.com/terraform-aws-modules/terraform-aws-eks.git --depth 1
      
      # 7. Inicializar Terraform (analizando 'terraform-aws-eks')
      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ./terraform-aws-eks
      
      # 7.1. Verificar que terraform-aws-modules existe despuÃ©s de init
      - name: Verificar directorio terraform-aws-modules
        run: |
          echo "Verificando estructura de directorios despuÃ©s de terraform init:"
          ls -la ./terraform-aws-eks/ | head -20
          echo ""
          echo "Buscando directorio terraform-aws-modules:"
          if [ -d "./terraform-aws-eks/terraform-aws-modules" ]; then
            echo "âœ… Directorio terraform-aws-modules/ EXISTE"
            find ./terraform-aws-eks/terraform-aws-modules -name "*.tf" | head -10
          else
            echo "âŒ Directorio terraform-aws-modules/ NO EXISTE"
            echo "Buscando en .terraform/modules:"
            if [ -d "./terraform-aws-eks/.terraform/modules" ]; then
              echo "âœ… Directorio .terraform/modules/ EXISTE"
              find ./terraform-aws-eks/.terraform/modules -name "*.tf" | head -10
            else
              echo "âŒ Directorio .terraform/modules/ TAMPOCO EXISTE"
            fi
          fi
      
      # 8. Ejecutar el Pipeline (analizando 'terraform-aws-eks')
      - name: Ejecutar Pipeline de GraphSec-IaC
        run: |
          python run_pipeline.py \
            --directory ./terraform-aws-eks \
            --project eks_pr_${{ github.event.pull_request.number || github.run_number }} \
            --output graph_data.json
      
      # 9. Renombrar artefacto JSON
      - name: Renombrar artefacto JSON
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.run_number }}"
          mv graph_data.json pr-${PR_NUMBER}.json
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
      
      # 10. Copiar index.html a la raÃ­z para GitHub Pages
      - name: Copiar index.html a la raÃ­z
        run: cp static/index.html index.html
      
      # 11. Preparar directorio de despliegue
      - name: Preparar directorio de despliegue
        run: mkdir deploy_dir
      
      # 12. Mover artefactos al directorio de despliegue
      - name: Mover artefactos al directorio de despliegue
        run: |
          mv pr-${PR_NUMBER}.json ./deploy_dir/
          mv index.html ./deploy_dir/
      
      # 13. Desplegar informe en GitHub Pages
      - name: Desplegar informe en GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: deploy_dir
      
      # 14. Publicar un comentario en el PR (solo si hay PR)
      - name: Publicar Comentario en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Cargar el JSON generado
            const fs = require('fs');
            const prNumber = context.issue.number;
            const results = JSON.parse(fs.readFileSync(`deploy_dir/pr-${prNumber}.json`, 'utf8'));
            
            // Usar valores por defecto ({})
            const metadata = results.api_metadata || {};
            const correlation = metadata.correlation_metadata || {};
            
            // Extraer mÃ©tricas
            const nodes_vulnerable = correlation.nodes_with_issues_count || 0;
            const findings_unique = metadata.total_findings_unique || 0;
            const nodes_total = metadata.total_nodes || 0;
            const findings_unassigned = metadata.unassigned_findings_count || 0;
            
            // Construir la URL del informe visual
            const report_url = `https://guillermop2002.github.io/GraphSec-IaC/?report=https://guillermop2002.github.io/GraphSec-IaC/pr-${prNumber}.json`;
            
            // Construir el comentario
            const body = `
            ## ðŸ”¬ AnÃ¡lisis de GraphSec-IaC Completado
            
            Se han analizado los cambios en la infraestructura.
            
            | MÃ©trica | Resultado |
            | :--- | :--- |
            | Nodos Vulnerables | **${nodes_vulnerable}** |
            | Hallazgos Ãšnicos | **${findings_unique}** |
            | Nodos Totales | ${nodes_total} |
            | Hallazgos No Asignados | ${findings_unassigned} |
            
            [**ðŸ”— Ver Informe Visual Interactivo**](${report_url})
            `;
            
            // Publicar el comentario
            github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });


