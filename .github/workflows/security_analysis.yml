name: 'GraphSec-IaC An√°lisis de Seguridad'

on:
  pull_request:
    branches: [ main ]

jobs:
  analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      # 1. Checkout del c√≥digo del PR
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
      
      # 2. Configurar Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. Configurar Terraform
      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
      
      # 4. Instalar Trivy (via apt-get)
      - name: Instalar Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
      
      # 5. Instalar dependencias de Python (Checkov, etc.)
      - name: Instalar dependencias
        run: pip install -r requirements.txt
      
      # 6. Inicializar Terraform (analizando 'test_infra' como demo)
      # CAMBIA ESTO por el directorio de tu proyecto real
      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ./test_infra
      
      # 7. Ejecutar el Pipeline (analizando 'test_infra')
      # CAMBIA ESTO por el directorio de tu proyecto real
      - name: Ejecutar Pipeline de GraphSec-IaC
        run: |
          python run_pipeline.py \
            --directory ./test_infra \
            --project test_infra_pr_${{ github.event.pull_request.number }} \
            --output graph_data.json
      
      # 8. Renombrar artefacto JSON
      - name: Renombrar artefacto JSON
        run: mv graph_data.json pr-${{ github.event.pull_request.number }}.json
      
      # 9. Copiar index.html a la ra√≠z para GitHub Pages
      - name: Copiar index.html a la ra√≠z
        run: cp static/index.html index.html
      
      # 10. Preparar directorio de despliegue
      - name: Preparar directorio de despliegue
        run: mkdir deploy_dir
      
      # 11. Mover artefactos al directorio de despliegue
      - name: Mover artefactos al directorio de despliegue
        run: |
          mv pr-${{ github.event.pull_request.number }}.json ./deploy_dir/
          mv index.html ./deploy_dir/
      
      # 12. Desplegar informe en GitHub Pages
      - name: Desplegar informe en GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: deploy_dir
      
      # 13. Publicar un comentario en el PR
      - name: Publicar Comentario en PR
        uses: actions/github-script@v7
        with:
          script: |
            // Cargar el JSON generado
            const fs = require('fs');
            const results = JSON.parse(fs.readFileSync(`pr-${context.issue.number}.json`, 'utf8'));
            
            // Usar valores por defecto ({})
            const metadata = results.api_metadata || {};
            const correlation = metadata.correlation_metadata || {};
            
            // Extraer m√©tricas
            const nodes_vulnerable = correlation.nodes_with_issues_count || 0;
            const findings_unique = metadata.total_findings_unique || 0;
            const nodes_total = metadata.total_nodes || 0;
            const findings_unassigned = metadata.unassigned_findings_count || 0;
            
            // Construir la URL del informe visual
            const report_url = `https://guillermop2002.github.io/GraphSec-IaC/?report=https://guillermop2002.github.io/GraphSec-IaC/pr-${context.issue.number}.json`;
            
            // Construir el comentario
            const body = `
            ## üî¨ An√°lisis de GraphSec-IaC Completado
            
            Se han analizado los cambios en la infraestructura.
            
            | M√©trica | Resultado |
            | :--- | :--- |
            | Nodos Vulnerables | **${nodes_vulnerable}** |
            | Hallazgos √önicos | **${findings_unique}** |
            | Nodos Totales | ${nodes_total} |
            | Hallazgos No Asignados | ${findings_unassigned} |
            
            [**üîó Ver Informe Visual Interactivo**](${report_url})
            `;
            
            // Publicar el comentario
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });


