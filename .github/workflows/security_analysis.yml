name: 'GraphSec-IaC An√°lisis de Seguridad'

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permite ejecuci√≥n manual desde GitHub Actions
  push:
    branches: [ main ]  # Ejecutar tambi√©n cuando se hace push a main

jobs:
  analysis:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      # 1. Checkout del c√≥digo del PR
      - name: Checkout del c√≥digo
        uses: actions/checkout@v4
      
      # 2. Configurar Python
      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # 3. Configurar Terraform
      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
      
      # 4. Instalar Trivy (via apt-get)
      - name: Instalar Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy
      
      # 5. Instalar dependencias de Python (Checkov, etc.)
      - name: Instalar dependencias de Python
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          # Forzar instalaci√≥n de checkov expl√≠citamente
          python -m pip install checkov
          # Verificar que checkov est√° instalado y disponible
          which checkov || echo "Checkov no encontrado en PATH"
          checkov --version || echo "Checkov no se puede ejecutar"
      
      # 6. Clonar el repositorio de EKS (para prueba)
      - name: Clonar el repositorio de EKS (para prueba)
        run: |
          git clone https://github.com/terraform-aws-modules/terraform-aws-eks.git --depth 1
      
      # 6.5. Cachear resultados del pipeline (grafo y esc√°neres)
      - name: Restaurar cach√© del pipeline
        id: cache-pipeline
        uses: actions/cache@v3
        with:
          path: .graphsec_cache
          key: pipeline-cache-${{ runner.os }}-${{ hashFiles('terraform-aws-eks/**/*.tf') }}-v24
          restore-keys: |
            pipeline-cache-${{ runner.os }}-
      
      # 6.6. Verificar contenido del cach√© restaurado
      - name: Verificar cach√© restaurado
        run: |
          echo "=== Cach√© restaurado: ${{ steps.cache-pipeline.outputs.cache-hit }} ==="
          if [ -d .graphsec_cache ]; then
            echo "=== Directorios de Checkov en cach√© ==="
            find .graphsec_cache -type d -name "checkov_eks_*" || echo "No se encontraron directorios de Checkov"
            echo ""
            echo "=== Archivos de Trivy en cach√© ==="
            find .graphsec_cache -type f -name "trivy_eks_*" | head -5 || echo "No se encontraron archivos de Trivy"
          else
            echo "Directorio .graphsec_cache no existe despu√©s de restaurar"
          fi
      
      # 7. Inicializar Terraform (analizando 'terraform-aws-eks')
      - name: Terraform Init
        run: terraform init -backend=false
        working-directory: ./terraform-aws-eks
      
      # 7.1. Verificar que terraform-aws-modules existe despu√©s de init
      - name: Verificar directorio terraform-aws-modules
        run: |
          echo "Verificando estructura de directorios despu√©s de terraform init:"
          ls -la ./terraform-aws-eks/ | head -20
          echo ""
          echo "Buscando directorio terraform-aws-modules:"
          if [ -d "./terraform-aws-eks/terraform-aws-modules" ]; then
            echo "‚úÖ Directorio terraform-aws-modules/ EXISTE"
            find ./terraform-aws-eks/terraform-aws-modules -name "*.tf" | head -10
          else
            echo "‚ùå Directorio terraform-aws-modules/ NO EXISTE"
            echo "Buscando en .terraform/modules:"
            if [ -d "./terraform-aws-eks/.terraform/modules" ]; then
              echo "‚úÖ Directorio .terraform/modules/ EXISTE"
              find ./terraform-aws-eks/.terraform/modules -name "*.tf" | head -10
            else
              echo "‚ùå Directorio .terraform/modules/ TAMPOCO EXISTE"
            fi
          fi
      
      # 8. Ejecutar el Pipeline (analizando 'terraform-aws-eks')
      # An√°lisis de EKS
      - name: Ejecutar Pipeline de GraphSec-IaC
        id: run_pipeline
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.run_number }}"
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
          # Usar nombre fijo para el cach√© ('eks'), pero el output JSON tendr√° el PR number
          python run_pipeline.py \
            --directory ./terraform-aws-eks \
            --project eks \
            --output graph_data.json
      
      # 8.5. Actualizar metadata del JSON con el PR number
      - name: Actualizar metadata del JSON
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.run_number }}"
          python -c "
          import json
          import sys
          pr_num = '${{ github.event.pull_request.number || github.run_number }}'
          with open('graph_data.json', 'r') as f:
              data = json.load(f)
          metadata = data.get('api_metadata', {})
          metadata['project_name'] = f'eks_pr_{pr_num}'
          metadata['pr_number'] = int(pr_num)
          data['api_metadata'] = metadata
          with open('graph_data.json', 'w') as f:
              json.dump(data, f, indent=2)
          "
      
      # 8.6. Verificar contenido del cach√© antes de guardar
      - name: Verificar contenido del cach√©
        run: |
          echo "=== Contenido de .graphsec_cache antes de guardar ==="
          if [ -d .graphsec_cache ]; then
            find .graphsec_cache -type f -o -type d | head -20
            echo ""
            echo "=== Directorios de Checkov ==="
            find .graphsec_cache -type d -name "checkov_eks_*" || echo "No se encontraron directorios de Checkov"
            echo ""
            echo "=== Archivos de Trivy ==="
            find .graphsec_cache -type f -name "trivy_eks_*" | head -5 || echo "No se encontraron archivos de Trivy"
          else
            echo "Directorio .graphsec_cache no existe"
          fi
      
      # 8.7. Guardar cach√© del pipeline
      - name: Guardar cach√© del pipeline
        uses: actions/cache@v3
        with:
          path: .graphsec_cache
          key: pipeline-cache-${{ runner.os }}-${{ hashFiles('terraform-aws-eks/**/*.tf') }}-v24
      
      # 9. Renombrar artefacto JSON
      - name: Renombrar artefacto JSON
        run: |
          PR_NUMBER="${{ github.event.pull_request.number || github.run_number }}"
          mv graph_data.json pr-${PR_NUMBER}.json
          echo "PR_NUMBER=${PR_NUMBER}" >> $GITHUB_ENV
      
      # 10. Copiar index.html a la ra√≠z para GitHub Pages
      - name: Copiar index.html a la ra√≠z
        run: cp static/index.html index.html
      
      # 11. Preparar directorio de despliegue
      - name: Preparar directorio de despliegue
        run: mkdir deploy_dir
      
      # 12. Copiar artefactos al directorio de despliegue
      - name: Copiar artefactos al directorio de despliegue
        run: |
          cp pr-${PR_NUMBER}.json ./deploy_dir/
          cp index.html ./deploy_dir/
      
      # 13. Desplegar informe en GitHub Pages
      - name: Desplegar informe en GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: deploy_dir
      
      # 14. Publicar un comentario en el PR (solo si hay PR)
      - name: Publicar Comentario en PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            // Cargar el JSON generado (desde la ra√≠z, antes de moverlo)
            const fs = require('fs');
            const prNumber = context.issue.number;
            
            // Intentar leer desde deploy_dir o desde la ra√≠z
            let jsonPath = `deploy_dir/pr-${prNumber}.json`;
            if (!fs.existsSync(jsonPath)) {
              jsonPath = `pr-${prNumber}.json`;
            }
            console.log(`Leyendo JSON desde: ${jsonPath}`);
            const results = JSON.parse(fs.readFileSync(jsonPath, 'utf8'));
            
            // Usar valores por defecto ({})
            const metadata = results.api_metadata || {};
            const correlation = metadata.correlation_metadata || {};
            
            // Extraer m√©tricas
            const nodes_vulnerable = correlation.nodes_with_issues_count || 0;
            const findings_unique = metadata.total_findings_unique || 0;
            const nodes_total = metadata.total_nodes || 0;
            const findings_unassigned = metadata.unassigned_findings_count || 0;
            
            // Construir la URL del informe visual
            const report_url = `https://guillermop2002.github.io/GraphSec-IaC/?report=https://guillermop2002.github.io/GraphSec-IaC/pr-${prNumber}.json`;
            
            // Construir el comentario
            const body = `## üî¨ An√°lisis de GraphSec-IaC Completado\n\nSe han analizado los cambios en la infraestructura.\n\n| M√©trica | Resultado |\n| :--- | :--- |\n| Nodos Vulnerables | **${nodes_vulnerable}** |\n| Hallazgos √önicos | **${findings_unique}** |\n| Nodos Totales | ${nodes_total} |\n| Hallazgos No Asignados | ${findings_unassigned} |\n\n[**üîó Ver Informe Visual Interactivo**](${report_url})`;
            
            // Publicar el comentario
            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            console.log('Comentario publicado exitosamente en PR #' + prNumber);


